+++
date        = "2021-06-05"
title       = "Canigó. Com exposar informació dels commits de Git mitjançant l'Actuator de Spring"
description = "Com exposar la informació dels commits de Git mitjançant l'Actuator de Spring ."
section     = "howtos"
categories  = ["canigo"]
key        = "JULIOL2021"
+++


## Introducció

L'objectiu d'aquest article és **mostrar l'ús del servei info de l'Actuator de Spring per a exposar l'informació dels commits fets al Git**.


## Justificació

Un dels principals reptes d'una aplicació és **identificar de forma fàcil i ràpida quin és el codi que hi ha desplegat**.

El plugin **git commit id** ens genera un fitxer git.properties amb informació detallada de l'ùltim commit fet al Git.

La llibreria `spring-boot-starter-actuator` ofereix (entre molts altres com beans, mètriques, helth, conditions, logger, etc) el http endpoint **info** que dóna informació que ens servirà per identificar el servei.

Farem servir conjuntament tots dos, plugin i actuator, per a mostrar informació i identificar ràpidament el codi desplegat.

## Plugin git commit id

Per a fer servir el plugin `git commit` és necessari afegir-ho al fitxer pom.xml. Per defecte el plugin cercarà informació
al repositori Git remot, si falla o no està disponible el servidor Git, la construcció fallarà.
Per a evitar això propossem afegir la configuració segënt:

### Plugin al fitxer `pom.xml`

```xml

  <plugin>
    <groupId>pl.project13.maven</groupId>
    <artifactId>git-commit-id-plugin</artifactId>
    <configuration>
      <offline>true</offline>
      <abbrevLength>40</abbrevLength>
      <failOnNoGitDirectory>false</failOnNoGitDirectory>
      <failOnUnableToExtractRepoInfo>false</failOnUnableToExtractRepoInfo>
    </configuration>
  </plugin>

```

### Funcionament

Executant la comanda `mvn clean package` el plugin generarà el fitxer ** ./target/classes/git.properties ** amb informació detalla de l'ùltim commit al Git

Exemple de fitxer `git.properties`

```properties

    #Generated by Git-Commit-Id-Plugin
    git.branch=master
    git.build.host=canigodev
    git.build.time=2022-06-30T11\:53\:50+0200
    git.build.user.email=raul.serrano@ticxcat.cat
    git.build.user.name=50206371q
    git.build.version=1.0.0
    git.closest.tag.commit.count=
    git.closest.tag.name=
    git.commit.author.time=2022-06-21T20\:38\:01+0200
    git.commit.committer.time=2022-06-21T20\:38\:01+0200
    git.commit.id=0b8bbc460781345e25a0a276ab5e85c4a6567a37
    git.commit.id.abbrev=0b8bbc460781345e25a0a276ab5e85c4a6567a37
    git.commit.id.describe=0b8bbc4-dirty
    git.commit.id.describe-short=0b8bbc4-dirty
    git.commit.message.full=Proves
    git.commit.message.short=Proves
    git.commit.time=2022-06-21T20\:38\:01+0200
    git.commit.user.email=raul.serrano@ticxcat.cat
    git.commit.user.name=50206371q
    git.dirty=true
    git.local.branch.ahead=0
    git.local.branch.behind=0
    git.remote.origin.url=https\://gitlab.ticxcat.cat/FWK/canigo/canigo3/demos/Canigo36/Canigo36WebRest.git
    git.tags=
    git.total.commit.count=2

```

## Actuator de spring-boot

Per a fer servir la llibreria `spring-boot-starter-actuator` és necessari afegir la dependència al fitxer pom.xml com es mostra a continuació:

### Dependència al fitxer `pom.xml`

```xml

  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
    <exclusions>
      <exclusion>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-logging</artifactId>
      </exclusion>
    </exclusions>
  </dependency>

```

### Configuració al fitxer `application.yml`

La llibreria ofereix diferents endpoints amb molta informació. Al nostre cas només configurarem l'endpoint `info`:

```yml

management:
  endpoints:
    web:
      exposure:
        include: info
  info:
    git:
      mode: full
      enabled: true
```


## Funcionament

Una vegada construïda i inciada l'aplicació, podem accedir via navegador web a l'endopoint info i ens mostrarà l'informació detallada de l'ùltim commit fet al Git:

![Acutator info amb Plugin commit Git Ejemplo 1](/images/howtos/2021-06-22-Howto-actuator-info-commit-git.jpg)

## Conclusió

És possible configurar un projecte Canigó per a poder identificar ràpidament el codi que està desplegat a un entorn.

## Referències

Per a més informació podeu consultar:

 * [Configuració plugin commit id](https://github.com/git-commit-id/git-commit-id-maven-plugin/blob/master/docs/using-the-plugin.md)
 * [Spring Boot Actuator](https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints)
 * [Exemple](https://www.youtube.com/watch?v=6XIakve0GjI&t=385s)
